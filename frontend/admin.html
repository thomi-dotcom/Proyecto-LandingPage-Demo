<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maison L√∫mina | Elite Admin</title>
  
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Palette Elite Dark */
      --bg: #090b10;
      --card: #12151c;
      --card-inner: #1a1f28;
      --text: #ffffff;
      --text-dim: #8a99af;
      --border: rgba(255, 255, 255, 0.07);
      --olive: #10b981;
      --accent: #d4af37; /* Dorado met√°lico */
      --danger: #ff5e57;
      --radius-xl: 28px;
      --radius-lg: 18px;
      --shadow-premium: 0 20px 40px rgba(0,0,0,0.4);
    }

    [data-theme="light"] {
      --bg: #f3f5f9;
      --card: #ffffff;
      --card-inner: #f8fafc;
      --text: #0f172a;
      --text-dim: #64748b;
      --border: #e2e8f0;
      --olive: #059669;
      --accent: #b8860b;
      --shadow-premium: 0 10px 40px rgba(0,0,0,0.08);
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    
    body {
      margin: 0;
      font-family: 'Plus Jakarta Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: all 0.4s ease;
      overflow-x: hidden;
    }

    .wrap { padding: 40px; max-width: 1800px; margin: 0 auto; }

    /* --- Toolbar Superior --- */
    .toolbar {
      position: sticky; top: 20px; z-index: 1000;
      background: rgba(var(--card), 0.7);
      backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      padding: 18px 30px; border-radius: var(--radius-lg);
      display: flex; gap: 20px; align-items: center;
      margin-bottom: 50px; box-shadow: var(--shadow-premium);
    }
    [data-theme="light"] .toolbar { background: rgba(255, 255, 255, 0.85); }

    .search-box { 
      flex: 1; display: flex; gap: 14px; background: rgba(0,0,0,0.25); 
      padding: 12px 20px; border-radius: 14px; border: 1px solid var(--border);
      transition: 0.3s;
    }
    .search-box:focus-within { border-color: var(--accent); background: rgba(0,0,0,0.4); }
    .search-box input { background: transparent; border: none; color: var(--text); width: 100%; outline: none; font-size: 15px; font-weight: 500; }

    /* --- Grid System --- */
    #menuContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 35px; align-items: start;
    }

    .section-block {
      background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius-xl); display: flex; flex-direction: column;
      max-height: 85vh; box-shadow: var(--shadow-premium);
      position: relative; overflow: hidden;
      animation: fadeInUp 0.5s ease backwards;
    }
    .section-block::before {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .section-header {
      padding: 28px 24px; display: flex; justify-content: space-between; align-items: center;
      background: linear-gradient(to bottom, rgba(255,255,255,0.02), transparent);
    }
    .section-title-input {
      font-size: 20px; font-weight: 800; border: none; background: transparent; 
      color: var(--text); outline: none; width: 80%; letter-spacing: -0.5px;
    }

    .items-container { padding: 0 24px 24px; overflow-y: auto; display: flex; flex-direction: column; gap: 24px; }

    /* --- Item Cards Elite --- */
    .item-card {
      background: var(--card-inner); border: 1px solid var(--border);
      border-radius: var(--radius-lg); padding: 24px;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .item-card:hover { border-color: rgba(212, 175, 55, 0.4); transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    .item-card.is-out { opacity: 0.4; filter: grayscale(1); border-style: dotted; }

    .input-group { margin-bottom: 18px; }
    label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 8px; display: block; }

    input, textarea {
      width: 100%; padding: 12px 16px; background: rgba(0,0,0,0.2);
      border: 1px solid var(--border); border-radius: 12px;
      color: var(--text); font-family: inherit; font-size: 14px;
      transition: 0.2s;
    }
    [data-theme="light"] input, [data-theme="light"] textarea { background: #fff; }
    input:focus, textarea:focus { border-color: var(--accent); outline: none; background: rgba(0,0,0,0.35); }

    /* --- Buttons --- */
    .btn {
      padding: 12px 24px; border-radius: 14px; border: 1px solid var(--border);
      background: var(--card-inner); color: var(--text); cursor: pointer;
      font-weight: 700; font-size: 13px; transition: 0.3s;
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn:hover { background: var(--text); color: var(--bg); transform: translateY(-2px); }
    .btn-primary { background: var(--accent); color: #000; border: none; }
    .btn-primary:hover { filter: brightness(1.2); box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }

    /* --- Stock Control --- */
    .stock-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--border); }
    .switch-pill {
      display: flex; align-items: center; gap: 10px; padding: 8px 18px;
      border-radius: 100px; background: rgba(0,0,0,0.3); cursor: pointer; 
      font-size: 11px; font-weight: 800; transition: 0.3s; border: 1px solid transparent;
    }
    .stock-active { background: rgba(16, 185, 129, 0.1); color: var(--olive); border-color: rgba(16, 185, 129, 0.3); }

    /* --- Notification Bar --- */
    .unsaved-bar {
      position: fixed; bottom: 35px; left: 50%; transform: translateX(-50%) translateY(150px);
      background: var(--text); color: var(--bg);
      padding: 18px 45px; border-radius: 100px;
      display: flex; align-items: center; gap: 40px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      z-index: 10000; transition: 0.6s cubic-bezier(0.68, -0.6, 0.32, 1.6);
    }
    .unsaved-bar.visible { transform: translateX(-50%) translateY(0); }
    .pulse { animation: pulseAnim 2s infinite; }

    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes pulseAnim { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

    /* Login / PIN Custom */
    .pinOverlay { position: fixed; inset: 0; background: var(--bg); z-index: 99999; display: flex; align-items: center; justify-content: center; }
  </style>
</head>
<body>

  <div class="pinOverlay" id="pinOverlay">
    <div style="text-align: center; width: 380px; padding: 50px; background: var(--card); border-radius: 40px; border: 1px solid var(--border); box-shadow: var(--shadow-premium);">
      <h1 style="margin-bottom: 10px; font-weight: 800; letter-spacing: -1.5px; color: var(--accent);">MAISON L√öMINA</h1>
      <p style="color: var(--text-dim); font-size: 14px; margin-bottom: 40px; font-weight: 500;">SISTEMA DE GESTI√ìN CENTRAL</p>
      <input type="password" id="pinInput" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="font-size: 40px; text-align: center; letter-spacing: 15px; margin-bottom: 35px; border: none; background: transparent; border-bottom: 2px solid var(--border); border-radius: 0; color: var(--text); width: 80%;">
      <button class="btn btn-primary" style="width:100%; padding: 20px; font-size: 15px; text-transform: uppercase; letter-spacing: 2px;" id="pinBtn">Acceder al Studio</button>
    </div>
  </div>

  <div class="wrap">
    <div class="header" style="display:flex; justify-content: space-between; align-items: flex-end; margin-bottom: 30px;">
      <div>
        <h2 style="margin:0; font-weight: 800; font-size: 32px; letter-spacing: -1px;">Editor de Men√∫</h2>
        <div style="display:flex; align-items:center; gap:8px; margin-top:5px;">
          <span style="width:8px; height:8px; background:var(--olive); border-radius:50%;"></span>
          <span style="color: var(--text-dim); font-size: 13px; font-weight: 600;">Servidor Sincronizado</span>
        </div>
      </div>
      <div style="display:flex; gap:15px;">
        <button class="btn" id="themeToggle" style="border-radius: 50%; width:50px; height:50px; padding:0;">üåì</button>
        <button class="btn" onclick="window.location.reload()" style="border-radius: 50%; width:50px; height:50px; padding:0;">üîÑ</button>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <span>üîç</span>
        <input id="searchInput" type="text" placeholder="Filtrar por cualquier t√©rmino...">
      </div>
      <button class="btn btn-primary" onclick="addNewSection()">+ CREAR CATEGOR√çA</button>
    </div>

    <div id="menuContainer"></div>
  </div>

  <div class="unsaved-bar" id="unsavedBar">
    <div style="display:flex; align-items:center; gap:15px;" class="pulse">
      <div style="width:12px; height:12px; background:var(--accent); border-radius:50%;"></div>
      <b style="font-size: 16px; letter-spacing: 0.5px;">HAY CAMBIOS SIN PUBLICAR</b>
    </div>
    <button class="btn btn-primary" id="btnSave" style="background: var(--bg); color: var(--text); padding: 12px 30px;">PUBLICAR CAMBIOS</button>
  </div>

  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <script src="config.js"></script>
  
  <script>
    const ADMIN_PIN = "1433"; 
    let menuData = null;
    let hasChanges = false;

    const notify = (text, type = "success") => {
      Toastify({
        text: text, duration: 3000, gravity: "top", position: "center",
        style: { 
          background: type === "success" ? "rgba(16, 185, 129, 0.95)" : "rgba(255, 94, 87, 0.95)", 
          backdropFilter: "blur(10px)", borderRadius: "16px", fontWeight: "700",
          boxShadow: "0 15px 30px rgba(0,0,0,0.3)", padding: "12px 24px"
        }
      }).showToast();
    };

    document.getElementById("pinBtn").onclick = () => {
      if(document.getElementById("pinInput").value === ADMIN_PIN) {
        document.getElementById("pinOverlay").style.display = "none";
        notify("Identidad Verificada");
      } else { notify("PIN No V√°lido", "error"); }
    };

    document.getElementById('themeToggle').onclick = () => {
      const current = document.body.getAttribute('data-theme');
      document.body.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    };

    async function init() {
      try {
        const res = await fetch(window.SITE_CONFIG.api.baseUrl);
        menuData = await res.json();
        render();
      } catch (e) { notify("Error al cargar base de datos", "error"); }
    }

    function markChanged() {
      hasChanges = true;
      document.getElementById('unsavedBar').classList.add('visible');
    }

    function render() {
      const container = document.getElementById('menuContainer');
      const term = document.getElementById('searchInput').value.toLowerCase();
      container.innerHTML = '';

      menuData.sections.forEach((section, secIdx) => {
        const filteredItems = section.items.filter(i => 
          i.name.toLowerCase().includes(term) || (i.desc && i.desc.toLowerCase().includes(term))
        );

        const secDiv = document.createElement('div');
        secDiv.className = 'section-block';
        secDiv.innerHTML = `
          <div class="section-header">
            <input type="text" class="section-title-input" value="${section.title}" oninput="menuData.sections[${secIdx}].title=this.value; markChanged();">
            <button class="btn btn-danger" style="padding:8px 12px; border:none; background:rgba(255,94,87,0.15)" onclick="deleteSection(${secIdx})">üóëÔ∏è</button>
          </div>
          <div class="items-container">
            ${filteredItems.map((item, i) => {
              const realIdx = section.items.indexOf(item);
              const isAvail = item.available !== false;
              return `
                <div class="item-card ${!isAvail ? 'is-out' : ''}">
                  <div class="input-group">
                    <label>T√≠tulo del Plato</label>
                    <input type="text" value="${item.name}" oninput="updateItem(${secIdx}, ${realIdx}, 'name', this.value)">
                  </div>
                  <div class="input-group">
                    <label>Precio Unitario</label>
                    <input type="number" value="${item.price}" oninput="updateItem(${secIdx}, ${realIdx}, 'price', Number(this.value))">
                  </div>
                  <div class="input-group">
                    <label>Descripci√≥n & Al√©rgenos</label>
                    <textarea rows="2" oninput="updateItem(${secIdx}, ${realIdx}, 'desc', this.value)">${item.desc || ''}</textarea>
                  </div>
                  <div class="input-group">
                    <label>Enlace de Imagen / Subida</label>
                    <div style="display:flex; gap:10px;">
                      <input type="text" id="img-${secIdx}-${realIdx}" value="${item.image || ''}" oninput="updateItem(${secIdx}, ${realIdx}, 'image', this.value)" style="flex:1">
                      <label class="btn" style="min-width:50px;">
                        üì§ <input type="file" hidden onchange="uploadFile(this, ${secIdx}, ${realIdx})">
                      </label>
                    </div>
                  </div>
                  <div class="stock-row">
                    <div class="switch-pill ${isAvail ? 'stock-active' : ''}" onclick="toggleStock(${secIdx}, ${realIdx})">
                      ${isAvail ? '‚óè ACTIVO EN MEN√ö' : '‚óã FUERA DE STOCK'}
                    </div>
                    <button class="btn btn-danger" style="padding:8px 12px; border:none; background:transparent;" onclick="deleteItem(${secIdx}, ${realIdx})">‚úï Eliminar</button>
                  </div>
                </div>
              `;
            }).join('')}
            <button class="btn" style="width:100%; border: 2px dashed var(--border); background:transparent; margin-top:15px;" onclick="addItem(${secIdx})">+ INSERTAR NUEVO PLATO</button>
          </div>
        `;
        container.appendChild(secDiv);
      });
    }

    window.updateItem = (s, i, f, v) => { menuData.sections[s].items[i][f] = v; markChanged(); };
    window.toggleStock = (s, i) => {
      menuData.sections[s].items[i].available = (menuData.sections[s].items[i].available === false);
      markChanged(); render();
      notify("Disponibilidad actualizada");
    };
    window.addItem = (s) => {
      menuData.sections[s].items.push({ name: "Plato de Ejemplo", price: 0, desc: "", available: true, image: "" });
      markChanged(); render();
      notify("Nuevo √≠tem a√±adido a la lista");
    };
    window.deleteItem = (s, i) => {
      menuData.sections[s].items.splice(i, 1);
      markChanged(); render();
      notify("Plato eliminado con √©xito", "error");
    };
    window.deleteSection = (s) => {
      if(confirm("¬øEst√°s seguro de que quieres eliminar toda esta categor√≠a?")) {
        menuData.sections.splice(s, 1);
        markChanged(); render();
        notify("Categor√≠a removida", "error");
      }
    };
    window.addNewSection = () => {
      menuData.sections.unshift({ title: "NUEVA CATEGOR√çA", items: [] });
      markChanged(); render();
      notify("Categor√≠a creada satisfactoriamente");
    };

    window.uploadFile = async (input, s, i) => {
      if(!input.files[0]) return;
      const formData = new FormData();
      formData.append('image', input.files[0]);
      const statusInput = document.getElementById(`img-${s}-${i}`);
      statusInput.value = "PROCESANDO...";
      notify("Subiendo archivo al servidor...");

      try {
        const res = await fetch("http://localhost:3000/api/upload", { method: "POST", body: formData });
        const data = await res.json();
        updateItem(s, i, 'image', data.filePath);
        statusInput.value = data.filePath;
        render();
        notify("Imagen procesada y guardada");
      } catch (e) { 
        notify("Fallo en la carga del archivo", "error");
        statusInput.value = "";
      }
    };

    document.getElementById('searchInput').oninput = render;
    document.getElementById('btnSave').onclick = async () => {
      const btn = document.getElementById('btnSave');
      btn.disabled = true; btn.textContent = "SINCRONIZANDO...";
      try {
        const res = await fetch(window.SITE_CONFIG.api.baseUrl, {
          method: "PUT", headers: { "Content-Type": "application/json" },
          body: JSON.stringify(menuData)
        });
        if(res.ok) {
          hasChanges = false;
          document.getElementById('unsavedBar').classList.remove('visible');
          notify("¬°Publicaci√≥n Global Exitosa!");
        }
      } catch (e) { notify("Error de sincronizaci√≥n con API", "error"); }
      btn.disabled = false; btn.textContent = "PUBLICAR CAMBIOS";
    };

    init();
  </script>
</body>
</html>