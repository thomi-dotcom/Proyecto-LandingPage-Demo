<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel de Admin | Maison L√∫mina</title>

  <style>
    :root {
      /* Tus variables originales */
      --bg: #0b0f12;
      --card: #141a1f;
      --text: #f6f7f8;
      --muted: rgba(255, 255, 255, 0.6);
      --border: rgba(255, 255, 255, 0.1);
      --toolbar-bg: rgba(20, 26, 31, 0.85);
      
      --olive: #3c8c64;
      --olive-2: #2f6f4e;
      --danger: #ff5252;
      --warn: #ffb74d;

      --radius: 18px;
      --shadow-sm: 0 10px 26px rgba(0,0,0,0.3);
      --focus: rgba(60, 140, 100, 0.25);
    }

    /* Clase para Tema Claro */
    [data-theme="light"] {
      --bg: #fbfaf7;
      --card: #ffffff;
      --text: #1f1f1d;
      --muted: rgba(31,31,29,.65);
      --border: rgba(31,31,29,.10);
      --toolbar-bg: rgba(251,250,247,.86);
      --olive: #2e5b3b;
      --olive-2: #244a31;
      --danger: #a12020;
      --warn: #b07a00;
      --shadow-sm: 0 10px 26px rgba(22,18,12,.07);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    .wrap{
      max-width: 1000px; /* Un poco m√°s ancho para las tarjetas */
      margin: 0 auto;
      padding: 18px 18px 80px; /* Espacio abajo para el bot√≥n flotante */
    }

    .header{
      display:flex; align-items:center; justify-content:space-between;
      gap:14px; flex-wrap:wrap; margin: 6px 0 14px;
    }
    h1{ margin:0; font-size: 26px; letter-spacing:.01em; }

    /* Toolbar */
    .toolbar{
      position: sticky; top: 10px; z-index: 100;
      background: var(--toolbar-bg); backdrop-filter: blur(10px);
      border: 1px solid var(--border); box-shadow: var(--shadow-sm);
      border-radius: var(--radius); padding: 12px; margin: 10px 0 20px;
      display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    }

    /* Inputs Gen√©ricos */
    input[type="text"], input[type="number"], textarea {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 8px;
      padding: 8px 10px;
      width: 100%;
      font-family: inherit;
      font-size: 14px;
    }
    [data-theme="light"] input, [data-theme="light"] textarea { background: #f0f0f0; border-color:#ccc; color: #000; }
    
    input:focus, textarea:focus { outline: none; border-color: var(--olive); }

    /* Botones */
    .btn{
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background: rgba(255,255,255,0.05); color: var(--text);
      cursor:pointer; font-weight:700; font-size:13px; transition: all .15s ease;
    }
    [data-theme="light"] .btn { background: #fff; border-color:#ddd; color:#333; }
    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    
    .btn-primary{ background: var(--olive); color:#fff; border:none; }
    .btn-danger { color: var(--danger); border-color: var(--danger); background: transparent; }

    /* --- NUEVO: Estilo Acorde√≥n y Tarjetas --- */
    .section-block {
      margin-bottom: 20px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      overflow: hidden;
    }
    
    .section-header {
      padding: 15px;
      background: rgba(255,255,255,0.03);
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      font-weight: 700; font-size: 15px;
    }
    .section-header:hover { background: rgba(255,255,255,0.06); }

    .items-container { display: none; padding: 15px; display: grid; gap: 15px; }
    .section-block.collapsed .items-container { display: none; }
    .section-block.collapsed .section-header { border-bottom: none; }

    /* Tarjeta de Producto */
    .item-card {
      display: grid; 
      grid-template-columns: 60px 1fr 40px; /* Switch | Inputs | Delete */
      gap: 15px;
      background: rgba(0,0,0,0.15);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      align-items: start;
    }
    [data-theme="light"] .item-card { background: #f4f4f4; border-color: #ddd; }

    .item-main { display: flex; flex-direction: column; gap: 10px; }
    .row-inputs { display: grid; grid-template-columns: 2fr 1fr; gap: 10px; }
    
    label { font-size: 10px; text-transform: uppercase; color: var(--muted); letter-spacing: 0.5px; display: block; margin-bottom: 4px; }

    /* Switch de Stock */
    .stock-switch {
      display: flex; flex-direction: column; align-items: center; gap: 6px; cursor: pointer;
    }
    .switch-track {
      width: 36px; height: 20px; background: #555; border-radius: 20px; position: relative; transition: 0.3s;
    }
    .switch-thumb {
      width: 14px; height: 14px; background: white; border-radius: 50%;
      position: absolute; top: 3px; left: 3px; transition: 0.3s;
    }
    /* Activo */
    .stock-active .switch-track { background: var(--olive); }
    .stock-active .switch-thumb { transform: translateX(16px); }
    .stock-label { font-size: 9px; font-weight: bold; color: var(--muted); text-align: center;}

    /* Barra Flotante de Guardado */
    .unsaved-bar {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--olive); color: white;
      padding: 12px 24px; border-radius: 50px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      display: flex; gap: 15px; align-items: center; z-index: 999;
      opacity: 0; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .unsaved-bar.visible { transform: translateX(-50%) translateY(0); opacity: 1; }

    /* PIN Overlay (Igual que antes) */
    .pinOverlay{ position: fixed; inset: 0; background: rgba(7,10,13,0.98); backdrop-filter: blur(5px); display:flex; align-items:center; justify-content:center; z-index: 9999; }
    .pinCard{ width: 300px; background: var(--card); border: 1px solid var(--border); border-radius: 24px; padding: 30px; text-align: center; }

    @media (max-width: 600px) {
      .item-card { grid-template-columns: 1fr; position: relative;}
      .stock-switch { flex-direction: row; justify-content: space-between; margin-bottom: 10px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; }
      .btn-delete-mobile { position: absolute; top: 10px; right: 10px; }
      .row-inputs { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>

<body>
  <div class="pinOverlay" id="pinOverlay">
    <div class="pinCard">
      <h2>Acceso Admin</h2>
      <input class="btn" style="width:100%; margin:10px 0; text-align:center; font-size:18px" id="pinInput" type="password" placeholder="PIN" />
      <button class="btn btn-primary" id="pinBtn" style="width:100%">Entrar</button>
      <div id="pinError" style="color:var(--danger); margin-top:10px; display:none">Incorrecto</div>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div>
        <h1>Panel Admin</h1>
        <div class="muted">Gesti√≥n total del men√∫.</div>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn" onclick="window.location.href='./index.html'">‚Üê Volver</button>
        <button class="btn" id="themeToggle">üåì Tema</button>
      </div>
    </div>

    <div class="toolbar">
      <div style="flex:1; display:flex; gap:10px; align-items:center;">
        <span>üîé</span>
        <input id="searchInput" type="text" placeholder="Buscar plato, ingrediente..." style="border:none; background:transparent; font-size:16px; padding:0;">
      </div>
      <button class="btn" onclick="expandAll(false)">Contraer Todo</button>
    </div>

    <div id="menuContainer"></div>
  </div>

  <div class="unsaved-bar" id="unsavedBar">
    <span style="font-weight:600">‚ö†Ô∏è Cambios sin guardar</span>
    <button class="btn" style="background:white; color:var(--olive); font-weight:800" id="btnSave">GUARDAR AHORA</button>
  </div>

  <script src="config.js"></script>

  <script>
    // --- 1. CONFIG Y VARIABLES ---
    const ADMIN_PIN = "1433"; 
    let menuData = null;
    let hasChanges = false;
    
    // --- 2. PIN Y TEMA ---
    const pinOverlay = document.getElementById("pinOverlay");
    const pinInput = document.getElementById("pinInput");
    
    document.getElementById("pinBtn").onclick = checkPin;
    pinInput.onkeydown = (e) => { if(e.key === 'Enter') checkPin() };

    function checkPin(){
      if (pinInput.value === ADMIN_PIN) {
        pinOverlay.style.display = "none";
      } else {
        document.getElementById("pinError").style.display = "block";
        pinInput.value = "";
      }
    }

    const themeBtn = document.getElementById('themeToggle');
    themeBtn.onclick = () => {
      const isLight = document.body.getAttribute('data-theme') === 'light';
      document.body.setAttribute('data-theme', isLight ? 'dark' : 'light');
    };

    // --- 3. LOGICA PRINCIPAL ---
    async function init() {
      try {
        const url = window.SITE_CONFIG.api.baseUrl;
        const res = await fetch(url);
        if(!res.ok) throw new Error("Error fetching");
        menuData = await res.json();
        
        // Parche de seguridad por si es un JSON viejo
        if (!menuData.sections) menuData.sections = [];
        
        render();
      } catch (e) {
        alert("Error cargando datos. Asegurate que el servidor backend est√© corriendo (npm start).");
        console.error(e);
      }
    }

    // Marca que hubo cambios y muestra el bot√≥n flotante
    function markChanged() {
      hasChanges = true;
      document.getElementById('unsavedBar').classList.add('visible');
      window.onbeforeunload = () => "Tienes cambios sin guardar";
    }

    // Renderiza todo el men√∫ (Acordeones + Tarjetas)
    function render() {
      const container = document.getElementById('menuContainer');
      container.innerHTML = '';
      const term = document.getElementById('searchInput').value.toLowerCase();

      menuData.sections.forEach((section, secIdx) => {
        // Filtramos items para la b√∫squeda
        const filteredItems = section.items.filter(i => 
          i.name.toLowerCase().includes(term) || (i.desc && i.desc.toLowerCase().includes(term))
        );

        if (term && filteredItems.length === 0) return; // Si busco y no hay nada aqu√≠, oculto secci√≥n

        const itemsToShow = term ? filteredItems : section.items;

        // Crear contenedor de secci√≥n
        const secDiv = document.createElement('div');
        secDiv.className = `section-block ${term ? '' : 'collapsed'}`; // Expandir si busco
        
        secDiv.innerHTML = `
          <div class="section-header" onclick="toggleSection(this)">
            <span>${section.title} <span style="font-weight:400; opacity:0.5; font-size:12px">(${itemsToShow.length})</span></span>
            <span style="opacity:0.5">‚ñº</span>
          </div>
          <div class="items-container">
            </div>
          <div style="padding:10px; background:rgba(0,0,0,0.1); text-align:center">
             <button class="btn" style="width:100%; border-style:dashed; opacity:0.7" onclick="addItem(${secIdx})">+ Agregar Plato a ${section.title}</button>
          </div>
        `;

        const itemsCont = secDiv.querySelector('.items-container');

        itemsToShow.forEach((item, itemIdx) => {
          // Importante: encontrar el √≠ndice real en el array original para no romper al editar filtrado
          const realIdx = section.items.indexOf(item);
          const isAvailable = item.available !== false; // Default true

          const card = document.createElement('div');
          card.className = 'item-card';
          card.innerHTML = `
            <div class="stock-switch ${isAvailable ? 'stock-active' : ''}" onclick="toggleStock(${secIdx}, ${realIdx})" title="Click para cambiar estado">
              <div class="switch-track"><div class="switch-thumb"></div></div>
              <div class="stock-label">${isAvailable ? 'STOCK' : 'AGOTADO'}</div>
            </div>

            <div class="item-main">
              <div class="row-inputs">
                <div>
                  <label>Nombre del Producto</label>
                  <input type="text" value="${item.name}" oninput="updateItem(${secIdx}, ${realIdx}, 'name', this.value)">
                </div>
                <div>
                  <label>Precio ($)</label>
                  <input type="number" value="${item.price}" oninput="updateItem(${secIdx}, ${realIdx}, 'price', Number(this.value))">
                </div>
              </div>
              
              <div>
                <label>Descripci√≥n / Ingredientes</label>
                <textarea rows="2" oninput="updateItem(${secIdx}, ${realIdx}, 'desc', this.value)">${item.desc || ''}</textarea>
              </div>

              <div>
  <label>Imagen (URL o Subir)</label>
  <div style="display:flex; gap:8px;">
    <input type="text" value="${item.image || ''}" 
           placeholder="./assets/foto.jpg" 
           id="img-input-${secIdx}-${realIdx}"
           oninput="updateItem(${secIdx}, ${realIdx}, 'image', this.value)">
    
    <label class="btn" style="padding:8px 12px; cursor:pointer;" title="Subir desde PC">
      üì§
      <input type="file" hidden accept="image/*" 
             onchange="uploadImage(this, ${secIdx}, ${realIdx})">
    </label>
  </div>
</div>

            <div style="text-align:right">
              <button class="btn btn-danger btn-delete-mobile" onclick="deleteItem(${secIdx}, ${realIdx})" title="Eliminar plato">‚úï</button>
            </div>
          `;
          itemsCont.appendChild(card);
        });

        container.appendChild(secDiv);
      });
    }

    // --- 4. FUNCIONES DE EDICI√ìN ---
    
    window.toggleSection = (header) => {
      header.parentElement.classList.toggle('collapsed');
    };

    window.expandAll = (expand) => {
      document.querySelectorAll('.section-block').forEach(el => 
        expand ? el.classList.remove('collapsed') : el.classList.add('collapsed')
      );
    };

    window.toggleStock = (secIdx, itemIdx) => {
      const item = menuData.sections[secIdx].items[itemIdx];
      item.available = item.available === false ? true : false;
      markChanged();
      render(); // Re-render para actualizar color visual
    };

    window.updateItem = (secIdx, itemIdx, field, val) => {
      menuData.sections[secIdx].items[itemIdx][field] = val;
      markChanged();
    };

    window.addItem = (secIdx) => {
      menuData.sections[secIdx].items.push({
        name: "Nuevo Producto",
        price: 0,
        desc: "",
        available: true
      });
      markChanged();
      render();
      // Abrir la secci√≥n autom√°ticamente
      const sections = document.querySelectorAll('.section-block');
      if(sections[secIdx]) sections[secIdx].classList.remove('collapsed');
    };

    window.deleteItem = (secIdx, itemIdx) => {
      if(!confirm("¬øBorrar este producto permanentemente?")) return;
      menuData.sections[secIdx].items.splice(itemIdx, 1);
      markChanged();
      render();
    };

    document.getElementById('searchInput').addEventListener('input', render);

    // --- 5. GUARDAR ---
    document.getElementById('btnSave').onclick = async () => {
      const btn = document.getElementById('btnSave');
      try {
        btn.textContent = "GUARDANDO...";
        btn.disabled = true;

        const url = window.SITE_CONFIG.api.baseUrl;
        
        const res = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(menuData)
        });

        if (!res.ok) throw new Error("Error en servidor");

        // √âxito
        hasChanges = false;
        window.onbeforeunload = null;
        document.getElementById('unsavedBar').classList.remove('visible');
        alert("¬°Men√∫ actualizado correctamente! ‚òÅÔ∏è");

      } catch (e) {
        alert("Error al guardar: " + e.message);
      } finally {
        btn.textContent = "GUARDAR AHORA";
        btn.disabled = false;
      }
    };

    // --- 6. SUBIR IMAGEN (Te faltaba esto) ---
    window.uploadImage = async (inputElement, secIdx, itemIdx) => {
      console.log("Intentando subir imagen...");
      
      if (!inputElement.files || !inputElement.files[0]) return;
      const file = inputElement.files[0];

      const formData = new FormData();
      formData.append('image', file);

      // Buscamos el input de texto para mostrar feedback
      const textInputId = `img-input-${secIdx}-${itemIdx}`;
      const textInput = document.getElementById(textInputId);
      
      if(!textInput) {
          console.error("No encuentro el campo de texto con ID:", textInputId);
          return;
      }

      // Feedback visual
      const originalValue = textInput.value;
      textInput.value = "Subiendo...";
      textInput.disabled = true;

      try {
        // Asegurate que el puerto 3000 sea el correcto
        const res = await fetch("http://localhost:3000/api/upload", {
          method: "POST",
          body: formData
        });

        if (!res.ok) throw new Error("Error en el servidor al subir");

        const data = await res.json();
        
        // ¬°√âxito!
        // 1. Actualizamos el dato en memoria
        updateItem(secIdx, itemIdx, 'image', data.filePath);
        // 2. Actualizamos el input visual
        textInput.value = data.filePath;
        
        // Opcional: Mostrar un tick verde temporal
        inputElement.parentElement.innerHTML = "‚úÖ"; 
        setTimeout(() => { 
            // Restaurar el bot√≥n de subida (opcional, requiere render completo o l√≥gica compleja, 
            // pero con el render() al guardar se arregla solo)
             render(); 
        }, 1000);

      } catch (e) {
        console.error(e);
        alert("Error al subir: " + e.message + "\n(Revis√° que el backend est√© corriendo)");
        textInput.value = originalValue; 
      } finally {
        textInput.disabled = false;
        inputElement.value = ""; // Limpiar para permitir subir otra
      }
    };

    // Inicio
    init();

  </script>
</body>
</html>3