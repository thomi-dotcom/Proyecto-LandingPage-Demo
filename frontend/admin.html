<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin | Maison L√∫mina</title>

  <style>
    :root {
      /* Tema Oscuro (Default) */
      --bg: #0b0f12;
      --card: #141a1f;
      --text: #f6f7f8;
      --muted: rgba(255, 255, 255, 0.6);
      --border: rgba(255, 255, 255, 0.1);
      --toolbar-bg: rgba(20, 26, 31, 0.85);
      
      --olive: #3c8c64;
      --olive-2: #2f6f4e;
      --danger: #ff5252;
      --warn: #ffb74d;

      --radius: 18px;
      --shadow-sm: 0 10px 26px rgba(0,0,0,0.3);
      --focus: rgba(60, 140, 100, 0.25);
    }

    /* Clase para Tema Claro */
    [data-theme="light"] {
      --bg: #fbfaf7;
      --card: #ffffff;
      --text: #1f1f1d;
      --muted: rgba(31,31,29,.65);
      --border: rgba(31,31,29,.10);
      --toolbar-bg: rgba(251,250,247,.86);
      --olive: #2e5b3b;
      --olive-2: #244a31;
      --danger: #a12020;
      --warn: #b07a00;
      --shadow-sm: 0 10px 26px rgba(22,18,12,.07);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s ease, color 0.3s ease;
    }

    body.is-locked{ overflow:hidden; }

    .wrap{
      max-width: 1150px;
      margin: 0 auto;
      padding: 18px 18px 64px;
    }

    .header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin: 6px 0 14px;
    }
    
    h1{ margin:0; font-size: 26px; letter-spacing:.01em; }

    /* Toolbar */
    .toolbar{
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--toolbar-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      border-radius: var(--radius);
      padding: 12px;
      margin: 10px 0 12px;
    }
    .toolbarGrid{
      display:grid;
      grid-template-columns: 1.3fr .9fr auto;
      gap: 10px;
      align-items:center;
    }

    .search{
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,0.05);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
    }
    [data-theme="light"] .search { background: #fff; }

    .search input{
      border:0;
      outline:none;
      flex:1;
      font-size:14px;
      background: transparent;
      color: inherit;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 12px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.03);
      font-size:13px;
      color: var(--muted);
    }
    [data-theme="light"] .pill { background: #fff; }
    .pill strong{ color: var(--text); font-weight:700; }

    /* Buttons */
    .btn{
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition: all .15s ease;
      white-space: nowrap;
    }
    [data-theme="light"] .btn { background: #fff; }

    .btn:hover{ transform: translateY(-1px); box-shadow: var(--shadow-sm); }

    .btnPrimary{
      background: linear-gradient(180deg, var(--olive), var(--olive-2));
      color:#fff;
      border: none;
    }

    /* List */
    .list{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-sm);
      overflow:hidden;
    }

    .listHead{
      display:grid;
      grid-template-columns: 1.05fr 1.4fr .8fr;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      color: var(--muted);
      font-size: 11px;
      text-transform: uppercase;
      background: rgba(255,255,255,0.02);
    }

    .itemRow{
      display:grid;
      grid-template-columns: 1.05fr 1.4fr .8fr;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
      align-items:center;
    }
    .itemRow:hover{ background: rgba(60, 140, 100, 0.08); }

    .sec{ font-weight:800; font-size: 13px; opacity: 0.8; }
    .name{ font-weight:700; font-size:14px; }
    .sub{ display:block; font-size:12px; color: var(--muted); margin-top: 2px; }

    input[type="number"]{
      width: 140px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      font-size: 14px;
      text-align:right;
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }
    [data-theme="light"] input[type="number"] { background: #fff; }

    .changed{
      background: rgba(60, 140, 100, 0.15) !important;
      border-color: var(--olive) !important;
    }

    /* PIN overlay */
    .pinOverlay{
      position: fixed;
      inset: 0;
      background: rgba(7,10,13,0.96);
      backdrop-filter: blur(10px);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index: 9999;
    }
    .pinCard{
      width: min(400px, 90%);
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 32px;
      text-align: center;
    }

    /* Scrollbar Dark */
    ::-webkit-scrollbar { width: 10px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.15);
      border-radius: 99px;
      border: 2px solid var(--bg);
    }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.3); }

    /* Mobile */
    @media (max-width: 860px){
      .toolbarGrid{ grid-template-columns: 1fr; }
      .listHead{ display:none; }
      .itemRow{ grid-template-columns: 1fr; }
    }

    /* Print */
    @media print {
      body { background: #fff !important; color: #000 !important; }
      .topbar, .header .btn, .toolbar, .status, .pinOverlay { display: none !important; }
      .wrap { padding: 0; max-width: 100%; }
      .list { box-shadow: none; border: none; }
      .itemRow { border-bottom: 1px dotted #ccc; page-break-inside: avoid; }
      input[type="number"] { border: none; background: transparent; text-align: right; font-weight: bold; color: #000; }
    }
  </style>
</head>

<body>
  <div class="pinOverlay" id="pinOverlay">
    <div class="pinCard">
      <h2 style="margin-top:0">Acceso Admin</h2>
      <p class="muted">Maison L√∫mina ‚Äî Panel de Precios</p>
      <input class="btn" style="width:100%; margin-top:10px; text-align:center; font-size:18px" id="pinInput" type="password" placeholder="PIN" />
      <button class="btn btnPrimary" id="pinBtn" style="width:100%; margin-top:10px; padding:15px">Entrar</button>
      <div id="pinError" style="color:var(--danger); margin-top:10px; display:none">PIN incorrecto</div>
    </div>
  </div>

  <div class="wrap">
    <div class="header">
      <div>
        <h1>Admin ‚Äî Precios</h1>
        <div class="muted">Gesti√≥n de men√∫ Maison L√∫mina.</div>
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" onclick="window.location.href='./index.html'">‚Üê Volver</button>
        <button class="btn" id="themeToggle">üåì Modo</button>
        <div class="pill">
          <span>Modif:</span> <strong id="changedCount">0</strong>
        </div>
      </div>
    </div>

    <div class="toolbar">
      <div class="toolbarGrid">
        <div class="search">
          <span>üîé</span>
          <input id="q" type="text" placeholder="Buscar producto o secci√≥n..." />
        </div>

        <label class="pill" style="cursor:pointer;">
          <input id="onlyChanged" type="checkbox" style="accent-color: var(--olive);" />
          <span>Ver solo modificados</span>
        </label>

        <div style="display:flex; gap:10px">
          <button class="btn" id="btnExport">Exportar JSON</button>
          <button class="btn btnPrimary" id="btnSave">Guardar</button>
        </div>
      </div>
    </div>

    <div class="list">
      <div class="listHead">
        <div>Secci√≥n</div>
        <div>Producto</div>
        <div style="text-align:right;">Precio</div>
      </div>
      <div id="listBody"></div>
    </div>
  </div>

  <script src="config.js"></script>

  <script>
    // ---- L√ìGICA DE TEMA ----
    const themeBtn = document.getElementById('themeToggle');
    themeBtn.onclick = () => {
      const isLight = document.body.getAttribute('data-theme') === 'light';
      document.body.setAttribute('data-theme', isLight ? 'dark' : 'light');
    };

    // ---- PIN ----
    const ADMIN_PIN = "1433"; 
    const overlay = document.getElementById("pinOverlay");
    const pinInput = document.getElementById("pinInput");
    const pinBtn = document.getElementById("pinBtn");
    
    function checkPin(){
      if (pinInput.value === ADMIN_PIN) {
        overlay.style.display = "none";
        document.body.classList.remove("is-locked");
      } else {
        document.getElementById("pinError").style.display = "block";
        pinInput.value = "";
      }
    }
    pinBtn.onclick = checkPin;
    pinInput.onkeydown = (e) => { if(e.key === 'Enter') checkPin() };

    // ---- GESTI√ìN DE DATOS (Nube) ----
    (async () => {
      const STORAGE_KEY = "menu_override_v1";
      const listBody = document.getElementById("listBody");
      const q = document.getElementById("q");
      const onlyChanged = document.getElementById("onlyChanged");
      const changedCountEl = document.getElementById("changedCount");
      const btnSave = document.getElementById("btnSave");

      let menu = null;
      let flat = [];
      let dirty = new Set();
      let originalPrices = new Map();

      // Carga de men√∫ (NUBE con fallback)
      async function loadMenu(){
        try {
          // Intentamos nube
          const config = window.SITE_CONFIG;
          if(config && config.api && config.api.binId){
            const { binId, apiKey } = config.api;
            const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
              headers: { 'X-Master-Key': apiKey }
            });
            if(res.ok){
              const json = await res.json();
              return json.record;
            }
          }
        } catch(e) { console.warn("Fallo nube en admin, usando local", e); }
        
        // Fallback local
        const local = localStorage.getItem(STORAGE_KEY);
        if(local) return JSON.parse(local);
        const res = await fetch("./data/menu.json");
        return res.json();
      }

      function normalize(menuObj){
        const out = [];
        if(!menuObj.sections) return out;
        menuObj.sections.forEach(sec => {
          sec.items.forEach(item => {
            const id = `${sec.id}-${item.name}`.replace(/\s+/g, '-').toLowerCase();
            out.push({ id, secTitle: sec.title, item, name: item.name });
            originalPrices.set(id, item.price);
          });
        });
        return out;
      }

      // ESTA es la funci√≥n que te daba error: ahora est√° segura dentro del bloque
      function updateCounters(){
        changedCountEl.textContent = dirty.size;
      }

      function render(){
        listBody.innerHTML = "";
        const query = q.value.toLowerCase();
        
        flat.forEach(r => {
          if (onlyChanged.checked && !dirty.has(r.id)) return;
          if (query && !r.name.toLowerCase().includes(query) && !r.secTitle.toLowerCase().includes(query)) return;

          const row = document.createElement("div");
          row.className = "itemRow";
          if(dirty.has(r.id)) row.classList.add("changed");

          row.innerHTML = `
            <div class="sec">${r.secTitle}</div>
            <div class="name">${r.name}<span class="sub">ARS</span></div>
            <div style="text-align:right">
              <input type="number" value="${r.item.price}" data-id="${r.id}">
            </div>
          `;

          const inp = row.querySelector('input');
          inp.oninput = () => {
            const val = Number(inp.value);
            r.item.price = val;
            
            // L√≥gica de "sucio" (modificado)
            if(val !== originalPrices.get(r.id)) dirty.add(r.id);
            else dirty.delete(r.id);
            
            updateCounters(); // Ahora s√≠ la encuentra :)

            if(val !== originalPrices.get(r.id)) row.classList.add("changed");
            else row.classList.remove("changed");
          };

          listBody.appendChild(row);
        });
      }

      menu = await loadMenu();
      flat = normalize(menu);
      render();

      q.oninput = render;
      onlyChanged.onchange = render;

      // BOT√ìN GUARDAR EN NUBE
      btnSave.onclick = async () => {
        try {
          btnSave.textContent = "Guardando...";
          btnSave.disabled = true;

          const config = window.SITE_CONFIG;
          if (!config || !config.api) throw new Error("Faltan claves API en config.js");
          const { binId, apiKey } = config.api;

          const res = await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              "X-Master-Key": apiKey
            },
            body: JSON.stringify(menu)
          });

          if (!res.ok) throw new Error("Error al guardar en la nube.");

          // Limpieza
          dirty.clear();
          localStorage.removeItem(STORAGE_KEY);
          updateCounters(); // Funciona perfecto aqu√≠ tambi√©n
          
          alert("¬°Guardado en la nube! ‚òÅÔ∏è\nLos cambios ya son visibles.");
          
        } catch (e) {
          alert("Error: " + e.message);
        } finally {
          btnSave.textContent = "Guardar";
          btnSave.disabled = false;
        }
      };

      document.getElementById("btnExport").onclick = () => {
        const blob = new Blob([JSON.stringify(menu, null, 2)], {type: "application/json"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "menu.json";
        a.click();
      };
      
      // Protecci√≥n al salir
      window.addEventListener("beforeunload", (e) => {
        if(dirty.size > 0){
          e.preventDefault();
          e.returnValue = "";
        }
      });
    })();
  </script>
</body>
</html>